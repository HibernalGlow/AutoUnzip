# findz 使用指南（完整中文版）

## 简介

**findz** 是一个强大的文件搜索工具，使用类似 SQL WHERE 子句的语法，支持：

- ✅ **SQL 风格查询**：使用熟悉的 WHERE 语法
- ✅ **压缩包内搜索**：自动搜索 ZIP、TAR、7Z、RAR 等格式
- ✅ **智能缓存**：自动建立索引，加速重复搜索
- ✅ **并行处理**：多线程扫描大量压缩包
- ✅ **压缩包过滤**：可只列出压缩包本身，不进入内部

## 快速开始

### 基本搜索

```bash
# 搜索当前目录下所有 Python 文件
findz "ext = 'py'"

# 搜索大于 10MB 的文件
findz "size > 10M"

# 搜索今天修改的文件
findz "date = today"

# 组合条件
findz "ext = 'py' AND size < 100K"
```

### 模糊匹配

```bash
# 查找文件名包含 test 的文件
findz "name LIKE '%test%'"

# 查找以 config 开头的文件
findz "name LIKE 'config%'"

# 不区分大小写
findz "name ILIKE 'README%'"

# 正则表达式
findz "name RLIKE '^test_.*\.py$'"
```

### 压缩包搜索

```bash
# 搜索所有压缩包内的文本文件
findz "ext = 'txt'" /path/to/archives

# 只列出压缩包文件本身（不进入内部）
findz "ext = 'zip'" --archives-only

# 只列出包含特定文件的压缩包
findz "name LIKE '%.log%'" --archives-only
```

## 支持的字段

| 字段名 | 说明 | 示例 |
|--------|------|------|
| `name` | 文件名（不含路径） | `name = 'test.py'` |
| `path` | 完整路径 | `path LIKE '%/src/%'` |
| `ext` | 扩展名（不含点） | `ext = 'py'` |
| `ext2` | 双扩展名 | `ext2 = 'tar.gz'` |
| `size` | 文件大小 | `size > 1M` |
| `date` | 修改日期 | `date = '2025-01-01'` |
| `time` | 修改时间 | `time > '14:00:00'` |
| `type` | 文件类型 | `type = 'file'` |
| `container` | 所在压缩包 | `container LIKE '%.zip'` |
| `archive` | 压缩包路径 | `archive IS NOT NULL` |
| `today` | 今天的日期 | `date = today` |
| `yesterday` | 昨天的日期 | `date = yesterday` |

## 大小单位

支持以下大小单位（不区分大小写）：

- `B` - 字节
- `K` / `KB` - 千字节（1024 字节）
- `M` / `MB` - 兆字节
- `G` / `GB` - 吉字节
- `T` / `TB` - 太字节

示例：
```bash
findz "size BETWEEN 1M AND 100M"
findz "size < 5.5G"
```

## 操作符

### 比较操作符
- `=` - 等于
- `!=` 或 `<>` - 不等于
- `<` - 小于
- `>` - 大于
- `<=` - 小于等于
- `>=` - 大于等于

### 模式匹配
- `LIKE` - SQL 通配符匹配（`%` 多个字符，`_` 单个字符）
- `ILIKE` - 不区分大小写的 LIKE
- `RLIKE` - 正则表达式匹配
- `NOT LIKE` - 不匹配模式

### 范围和集合
- `BETWEEN x AND y` - 在范围内
- `NOT BETWEEN x AND y` - 不在范围内
- `IN (a, b, c)` - 在集合中
- `NOT IN (a, b, c)` - 不在集合中

### 逻辑操作符
- `AND` - 逻辑与
- `OR` - 逻辑或
- `NOT` - 逻辑非

### 空值检查
- `IS NULL` - 为空
- `IS NOT NULL` - 不为空

## 命令行选项

### 基本选项

```bash
-l, --long              # 显示详细信息（日期、大小）
--csv                   # 输出为 CSV 格式（带表头）
--csv-no-head           # 输出为 CSV 格式（无表头）
-L, --follow-symlinks   # 跟随符号链接
```

### 压缩包选项

```bash
-n, --no-archive        # 禁用压缩包支持（加速搜索）
-A, --archives-only     # 只输出压缩包本身，不搜索内部
--no-cache              # 禁用索引缓存（强制重新扫描）
-j, --workers N         # 设置并行线程数（默认4）
```

### 其他选项

```bash
-0, --print0            # 使用空字符分隔（配合 xargs -0）
-H, --filter-help       # 显示过滤语法帮助
-V, --version           # 显示版本信息
-i, --interactive       # 进入交互模式
```

## 性能优化

### 1. 索引缓存

findz 会自动为扫描过的压缩包建立索引缓存，存储在 `~/.findz_cache/` 目录：

```bash
# 查看缓存目录
dir %USERPROFILE%\.findz_cache

# 清空缓存（如需重新扫描所有压缩包）
rmdir /s /q %USERPROFILE%\.findz_cache
```

缓存特性：
- ✅ 自动检测文件修改（基于大小、时间戳）
- ✅ 大幅加速重复搜索（无需重新解压）
- ✅ 支持增量更新

### 2. 并行处理

对于大量压缩包，使用多线程并行扫描：

```bash
# 使用 8 个线程并行处理
findz "ext = 'txt'" /large/archive/dir -j 8

# 单线程模式（调试时使用）
findz "ext = 'txt'" /large/archive/dir -j 1
```

### 3. 跳过压缩包

如果不需要搜索压缩包内部，禁用可大幅提升速度：

```bash
# 只搜索普通文件
findz "ext = 'py'" --no-archive
```

### 4. 只搜索压缩包

如果只需要找压缩包文件本身：

```bash
# 列出所有 ZIP 文件（不扫描内部）
findz "ext = 'zip'" --archives-only

# 列出大于 100MB 的压缩包
findz "size > 100M AND (ext = 'zip' OR ext = 'tar')" --archives-only
```

## 实际应用场景

### 场景 1：清理大文件

```bash
# 查找所有大于 1GB 的文件
findz "size > 1G" -l

# 查找大型日志文件
findz "ext = 'log' AND size > 100M" -l
```

### 场景 2：查找重复扩展名

```bash
# 查找所有 .tar.gz 文件
findz "ext2 = 'tar.gz'"

# 查找所有双扩展名文件
findz "ext2 IS NOT NULL"
```

### 场景 3：搜索压缩包内容

```bash
# 在所有 ZIP 中查找配置文件
findz "name LIKE 'config%' AND container LIKE '%.zip'"

# 查找包含特定文件的压缩包
findz "name = 'README.md' AND archive IS NOT NULL" --archives-only
```

### 场景 4：按日期筛选

```bash
# 今天修改的文件
findz "date = today"

# 昨天修改的文件
findz "date = yesterday"

# 特定日期范围
findz "date BETWEEN '2025-01-01' AND '2025-01-31'"

# 上午修改的文件
findz "time < '12:00:00'"
```

### 场景 5：批量处理

```bash
# 配合 xargs 删除临时文件
findz "name LIKE '%.tmp'" -0 | xargs -0 rm

# 统计所有 Python 文件的总行数
findz "ext = 'py'" -0 | xargs -0 wc -l

# 复制所有文档到目标目录
findz "ext IN ('doc', 'docx', 'pdf')" -0 | xargs -0 -I {} cp {} /target/dir/
```

## 交互模式

如果不带参数运行，或使用 `-i` 选项，将进入交互模式：

```bash
findz
# 或
findz -i
```

交互模式会逐步引导您构建查询：
1. 选择过滤类型
2. 输入过滤条件
3. 选择搜索路径
4. 确认并执行

## 输出格式

### 普通格式（默认）

```
D:\path\to\file1.txt
D:\path\to\file2.py
archive.zip//internal/file.txt
```

### 详细格式（-l）

```
2025-01-15 10:30:45      1.5K D:\path\to\file1.txt
2025-01-15 11:20:33     15.2M D:\path\to\file2.py
2025-01-15 09:15:22      2.3K archive.zip//internal/file.txt
```

### CSV 格式（--csv）

```csv
name,path,size,date,time,ext,ext2,type,container,archive
file1.txt,D:\path\to\file1.txt,1536,2025-01-15,10:30:45,txt,,file,,
```

## 注意事项

1. **Windows 路径**：使用单引号包裹路径中的反斜杠
   ```bash
   findz "path LIKE '%\\src\\%'"
   ```

2. **特殊字符**：在 WHERE 表达式中使用双引号包裹字符串
   ```bash
   findz "name = \"my file.txt\""
   ```

3. **缓存一致性**：文件修改后缓存会自动失效，如需强制重新扫描使用 `--no-cache`

4. **性能建议**：
   - 搜索上万个压缩包时，首次会较慢（建立缓存）
   - 后续搜索会显著加速
   - 适当增加 `-j` 参数提升并行度
   - 使用 `--archives-only` 可避免扫描内部

## 常见问题

**Q: 为什么搜索很慢？**  
A: 首次扫描压缩包需要建立索引。后续搜索会使用缓存，速度会大幅提升。也可以增加 `-j` 参数启用更多并行线程。

**Q: 如何只搜索压缩包文件本身？**  
A: 使用 `--archives-only` 选项，这样不会扫描压缩包内部。

**Q: 缓存存储在哪里？**  
A: 默认存储在 `~/.findz_cache/`（Windows 为 `%USERPROFILE%\.findz_cache`）

**Q: 如何清空缓存？**  
A: 删除缓存目录，或使用 `--no-cache` 选项跳过缓存。

**Q: 支持哪些压缩格式？**  
A: 支持 ZIP、TAR、GZ、BZ2、XZ、7Z、RAR 等常见格式（需安装对应的 Python 库）。

## 更多示例

```bash
# 查找所有空文件
findz "size = 0"

# 查找没有扩展名的文件
findz "ext = ''"

# 查找所有隐藏文件（Linux/Mac）
findz "name LIKE '.%'"

# 查找所有可执行文件（Windows）
findz "ext IN ('exe', 'bat', 'cmd')"

# 查找所有媒体文件
findz "ext IN ('mp4', 'avi', 'mkv', 'mp3', 'flac')"

# 查找最近一周修改的大文件
findz "date >= '2025-01-08' AND size > 50M"

# 查找特定用户创建的文件（需在用户目录下）
findz "path LIKE '%\\username\\%' AND date = today"
```

---

**提示**：使用 `findz --filter-help` 查看完整的过滤语法参考。
